---
title: "Analysis"
---

Summary: Analysis for black lives longevity project. 

## Setup 

Read in package 
```{r setup}
## library packages
library(data.table)
library(tidyverse)
library(stargazer)
library(broom) ## puts model output into "tidy" data.frame
library(cowplot) ## ggplot themes 
library(lfe) ## deprecated on cran
library(huxtable) ## output regression tables 
library(fixest) ## fast fixed-effect linear models
library(here) ## relative paths 

## set threads for computing 
setFixest_nthreads(1)

siblings <- fread(here("data/analysis_file.csv")) %>%  filter(bpl < 15000)

siblings_restricted <- fread(here("data/analysis_file_restricted.csv")) %>%  filter(bpl < 15000)
```


## Main Models (for Black)

First, we run an analysis with fixed effects for birth cohort, family, and birth order. 

```{r}
## siblings with no limits on death year imposed 
all_sibs_nolim <- siblings %>% 
  filter(byear %in% 1915:1925)  %>% 
  filter(!is.na(bni_std)) %>% 
  filter(fname_std_freq > 500) %>% 
  group_by(family) %>% 
  filter(n() %in% 2:5) 

model = feols(death_age ~ bni_std | byear, data = siblings_restricted) 
model_family_byear = feols(death_age ~ bni_std | byear + family ,  data = siblings_restricted)
model_family_byear_birth_order = feols(death_age ~ bni_std | byear + family + birth_order ,  data = siblings_restricted)
model_family_byear_birth_order_nolim = feols(death_age ~ bni_std | byear + family + birth_order,  data = all_sibs_nolim)

etable(model, model_family_byear, model_family_byear_birth_order, model_family_byear_birth_order_nolim, tex = T, file = here("tables/table1_main_models.tex"))
```


# Appendix 

## exact match siblings 
```{r}
## define exact sibs dataset 
exact_sibs <- siblings %>% 
  filter(byear %in% 1915:1925)  %>% 
  filter(dyear %in% 1988:2005) %>% 
  filter(!is.na(bni_std)) %>% 
  filter(fname_std_freq > 500) %>% 
  filter(exact_match == 1) %>% 
  group_by(family) %>%  
  filter(n() %in% 2:5) 
 
## define additional sibs 
additional_sibs <- siblings %>% 
  filter(byear %in% 1915:1925)  %>% 
  filter(dyear %in% 1988:2005) %>% 
  filter(!is.na(bni_std)) %>% 
  filter(fname_std_freq > 500) %>% 
  filter(exact_match == 0) %>% 
  group_by(family) %>%  
  filter(n() %in% 2:5) 

## define all sibs 
all_sibs <- siblings %>% 
  filter(byear %in% 1915:1925)  %>% 
  filter(dyear %in% 1988:2005) %>% 
  filter(!is.na(bni_std)) %>% 
  filter(fname_std_freq > 500) %>% 
  group_by(family) %>% 
  filter(n() %in% 2:5) 

bni.add.sibs = feols(death_age ~ bni_std | family + birth_order + byear,  data = additional_sibs)
bni.exact.sibs = feols(death_age ~ bni_std | family + birth_order + byear,  data = exact_sibs)
bni.all.sibs = feols(death_age ~ bni_std | family + birth_order + byear,  data = all_sibs)

etable(bni.exact.sibs, bni.add.sibs, bni.all.sibs, tex = T)
```


## Table: Establishing siblingship  

The code below outputs two tables providing concrete examples of our procedure for identifying siblings in this analysis. 

```{r create tables for siblingship}
## create table of matches 
knitr::kable(siblings %>% 
  filter(family %in% sample(unique(family), 3)) %>% 
  select(fname_std, lname, father_fname_clean, father_lname_clean, mother_fname_clean, mother_lname_clean, bpl_string) %>% 
  mutate(across(where(is.character), tolower)) %>% 
  mutate(across(where(is.character), tools::toTitleCase)),
  format = "latex", booktabs = T)  

## create table of matches 
knitr::kable(siblings %>% 
  filter(lev_distance_father > 0) %>% 
  filter(family %in% sample(unique(family), 3)) %>% 
  select(fname_std, lname, bpl_string, father_fname_clean, father_lname_clean, mother_fname_clean, mother_lname_clean, lev_distance_father) %>% 
  mutate(across(where(is.character), tolower)) %>% 
  mutate(across(where(is.character), tools::toTitleCase)),
  format = "latex", booktabs = T)  
```

## Miscallaneous Analyses   

1. Run without birth year fixed effects (high-priority)

- Birth year FE are important. Birth order FE less so. 



## Proportion black vs. BNI

Redo analysis with proportion black as predictor (instead of BNI)
```{r visualize BNI vs. porportion black}
bni_plot1 <- all_sibs %>% 
  ggplot() + 
  geom_histogram(aes(x = bni_std), binwidth = .1, color = "black", fill = "grey") + 
  cowplot::theme_cowplot(15) + 
  labs(x = "BNI", y = "Count")

bni_plot2 <-  all_sibs %>% 
  ggplot() + 
  geom_histogram(aes(x = prop_black), binwidth = .1, color = "black", fill = "grey") + 
  cowplot::theme_cowplot(15) + 
  labs(x = "Proportion Black", y = "Count")

bni_plot3 <- all_sibs %>% 
  ggplot(aes(x = bni_std, y = prop_black)) +
  geom_point() + 
  cowplot::theme_cowplot(15) + 
  labs(x = "BNI", y = "Proportion Black")

bni_plots <- cowplot::plot_grid(bni_plot1, bni_plot2, bni_plot3,  labels = c('A', 'B', 'C'), ncol = 3)

ggsave(plot = bni_plots, filename = here("figures/bni_proportion.pdf"), width = 12, height = 4) 
```

```{r}
model_family = feols(death_age ~ prop_black | family,  data = all_sibs)
model_family_byear = feols(death_age ~ prop_black | family  + byear,  data = all_sibs)
model_family_byear_birth_order = feols(death_age ~ prop_black | family + birth_order + byear,  data = all_sibs)

etable(model_family, model_family_byear, model_family_byear_birth_order, tex = T)
```

## Zip Benefits (Outcome)

Rerun model with Zip an outcome variable. Do people with blacker names end up living in richer zip codes?

```{r Zip Benefits Analysis}
model = feols(zip_ben ~ bni_std | byear,  data = all_sibs)
model_family = feols(zip_ben ~ bni_std | byear + family,  data = all_sibs)
model_family_byear = feols(zip_ben ~ bni_std | family  + byear,  data = all_sibs)
model_family_byear_birth_order = feols(zip_ben ~ bni_std | family + birth_order + byear,  data = all_sibs)

etable(model, model_family, model_family_byear, model_family_byear_birth_order, tex = T)
```





## Black vs. White Sibs

```{r, eval = F}
## all sibs 
bunmd_sibs <- fread("/censoc/data/working_files/00_cleaned_sibs.csv")

white_sibs <- bunmd_sibs %>% 
  filter(bpl < 15000) %>% 
  filter(byear %in% 1915:1925)  %>% 
  filter(dyear %in% 1988:2005) %>% 
  filter(!is.na(bni_std)) %>% 
  filter(fname_std_freq > 500) %>% 
  filter(race == 1) %>% 
  group_by(family) %>% 
  filter(n() %in% 2:5)

## birth order 
white_sibs <- white_sibs %>% 
  group_by(family) %>%
  arrange(byear, bmonth, bday, .by_group = TRUE) %>%
  mutate(birth_order = row_number())

model.whites = feols(death_age ~ bni_std | family + byear + birth_order,  data = white_sibs, nthreads = 1)

model.blacks = feols(death_age ~ bni_std | family + byear + birth_order,  data = all_sibs, nthreads = 1)

etable(model.whites, model.blacks, tex = T)
```

## Warren Analysis

```{r Warren Analysis}
## same birth cohorts (1910-1920) 
## unstandardized names, predictor is percentage black  
## 

# warren_replication <- siblings %>% 
#   filter(byear %in% 1910:1920) %>% 
#   filter(!is.na(prop_black_unstandardized)) %>% 
#   filter(fname_unstandardized_freq > 100) %>% 
#   group_by(family) %>% 
#   filter(n() %in% 2:5) 
# 
# 
# warren_model = feols(death_age ~ prop_black_unstandardized | family + birth_order,  data = warren_replication)

```



